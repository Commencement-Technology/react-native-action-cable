var APP_STATE_ACTIVE,AppState,ConnectionMonitor;({AppState:AppState}=require("react-native")),APP_STATE_ACTIVE="active",ConnectionMonitor=function(){var t,n,e;class i{constructor(t,n){this.start=this.start.bind(this),this.stop=this.stop.bind(this),this.isRunning=this.isRunning.bind(this),this.recordPing=this.recordPing.bind(this),this.recordConnect=this.recordConnect.bind(this),this.recordDisconnect=this.recordDisconnect.bind(this),this.startPolling=this.startPolling.bind(this),this.stopPolling=this.stopPolling.bind(this),this.poll=this.poll.bind(this),this.getPollInterval=this.getPollInterval.bind(this),this.reconnectIfStale=this.reconnectIfStale.bind(this),this.connectionIsStale=this.connectionIsStale.bind(this),this.disconnectedRecently=this.disconnectedRecently.bind(this),this.visibilityDidChange=this.visibilityDidChange.bind(this),this.connection=t,this.log=n,this.reconnectAttempts=0}start(){if(!this.isRunning())return this.startedAt=n(),delete this.stoppedAt,this.startPolling(),this.appStateEventListener=AppState.addEventListener("change",this.visibilityDidChange),this.log(`ConnectionMonitor started. pollInterval = ${this.getPollInterval()} ms`)}stop(){var t;if(this.isRunning())return this.stoppedAt=n(),this.stopPolling(),null!=(t=this.appStateEventListener)&&t.remove(),this.log("ConnectionMonitor stopped")}isRunning(){return null!=this.startedAt&&null==this.stoppedAt}recordPing(){return this.pingedAt=n()}recordConnect(){return this.reconnectAttempts=0,this.recordPing(),delete this.disconnectedAt,this.log("ConnectionMonitor recorded connect")}recordDisconnect(){return this.disconnectedAt=n(),this.log("ConnectionMonitor recorded disconnect")}startPolling(){return this.stopPolling(),this.poll()}stopPolling(){return clearTimeout(this.pollTimeout)}poll(){return this.pollTimeout=setTimeout((()=>(this.reconnectIfStale(),this.poll())),this.getPollInterval())}getPollInterval(){var n,e,i;return({min:i,max:e}=this.constructor.pollInterval),n=5*Math.log(this.reconnectAttempts+1),Math.round(1e3*t(n,i,e))}reconnectIfStale(){if(this.connectionIsStale())return this.log(`ConnectionMonitor detected stale connection. reconnectAttempts = ${this.reconnectAttempts}, pollInterval = ${this.getPollInterval()} ms, time disconnected = ${e(this.disconnectedAt)} s, stale threshold = ${this.constructor.staleThreshold} s`),this.reconnectAttempts++,this.disconnectedRecently()?this.log("ConnectionMonitor skipping reopening recent disconnect"):(this.log("ConnectionMonitor reopening"),this.connection.reopen())}connectionIsStale(){var t;return e(null!=(t=this.pingedAt)?t:this.startedAt)>this.constructor.staleThreshold}disconnectedRecently(){return this.disconnectedAt&&e(this.disconnectedAt)<this.constructor.staleThreshold}visibilityDidChange(){if(AppState.currentState===APP_STATE_ACTIVE)return setTimeout((()=>{if(this.connectionIsStale()||!this.connection.isOpen())return this.log(`ConnectionMonitor reopening stale connection on change. visbilityState = ${AppState.currentState}`),this.connection.reopen()}),200)}}return i.pollInterval={min:3,max:30},i.staleThreshold=6,n=function(){return(new Date).getTime()},e=function(t){return(n()-t)/1e3},t=function(t,n,e){return Math.max(n,Math.min(e,t))},i}.call(this);export default ConnectionMonitor;